<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Task Manager</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }

    .task-form {
      margin-bottom: 20px;
    }

    .action-btn {
      padding: 10px 16px;
      margin-right: 10px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .action-btn:hover {
      background-color: #0056b3;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 0 8px;
      height: 48px;
      text-align: left;
      vertical-align: middle;
    }

    tr {
      height: 48px;
    }

    .task-name {
      display: inline-block;
      height: 34px;
      line-height: 34px;
      padding: 0 10px;
      border: 1px solid #ddd;
      border-radius: 3px;
      min-width: 150px;
      vertical-align: middle;
    }

    select {
      height: 34px;
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 3px;
      background-color: #fff;
      font-size: 14px;
      vertical-align: middle;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2210%22%20height%3D%227%22%20viewBox%3D%220%200%2010%207%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%3E%3Cpath%20d%3D%22M0%200l5%207%205-7z%22%20fill%3D%22%23666%22/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 10px 7px;
      padding-right: 30px;
    }

    .drag-handle {
      cursor: grab;
    }

    #bulkActions {
      display: none;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

<div class="task-form">
  <button class="action-btn" onclick="addTask()">Add Task</button>
  <button class="action-btn" onclick="applyWorkflow()">Apply Workflow</button>
</div>

<div id="bulkActions">
  <button class="action-btn" onclick="deleteSelected()">Delete</button>
</div>

<table>
  <thead>
    <tr>
      <th></th>
      <th>#</th>
      <th>Task</th>
      <th>Task Name</th>
      <th>Status</th>
      <th>Group</th>
    </tr>
  </thead>
  <tbody id="taskTableBody"></tbody>
</table>

<script>
let tasks = [];

function renderTable() {
  const tbody = document.getElementById('taskTableBody');
  tbody.innerHTML = "";

  // Step 1: Recalculate grouping based on neighbors
  tasks.forEach((task, i) => {
    const prev = tasks[i - 1];
    const next = tasks[i + 1];
    const isPrevSeq = prev && prev.group === 'group-sequential';
    const isNextSeq = next && next.group === 'group-sequential';

    if (task.group === 'group-sequential' && !isPrevSeq && !isNextSeq) {
      task.group = 'group-independent';
      task.groupKey = crypto.randomUUID();
    }

    if (task.group !== 'group-sequential' && (isPrevSeq || isNextSeq)) {
      task.group = 'group-sequential';
      task.groupKey = (isPrevSeq ? prev.groupKey : next.groupKey) || crypto.randomUUID();
    }
  });

  // Step 2: Renumber tasks
  let currentNumber = 1;
  let lastGroupKeys = { 'group-parallel': {}, 'group-sequential': {} };

  tasks.forEach((task, index) => {
    let taskNumber = "";

    if (task.group === "group-independent") {
      taskNumber = currentNumber++;
    } else if (task.group === "group-parallel") {
      if (!(task.groupKey in lastGroupKeys['group-parallel'])) {
        lastGroupKeys['group-parallel'][task.groupKey] = currentNumber++;
      }
      taskNumber = lastGroupKeys['group-parallel'][task.groupKey];
    } else if (task.group === "group-sequential") {
      if (!(task.groupKey in lastGroupKeys['group-sequential'])) {
        lastGroupKeys['group-sequential'][task.groupKey] = { main: currentNumber++, sub: 1 };
      } else {
        lastGroupKeys['group-sequential'][task.groupKey].sub++;
      }
      const { main, sub } = lastGroupKeys['group-sequential'][task.groupKey];
      taskNumber = main + "." + sub;
    }

    task.number = taskNumber;
  });

  // Step 3: Render tasks
  tasks.forEach((task, i) => {
    const row = document.createElement('tr');
    row.setAttribute('draggable', 'true');
    row.ondragstart = (e) => { e.dataTransfer.setData("text/plain", i); };
    row.ondragover = (e) => { e.preventDefault(); };
    row.ondrop = (e) => {
      const from = +e.dataTransfer.getData("text/plain");
      const to = i;
      if (from !== to) {
        const moved = tasks.splice(from, 1)[0];
        tasks.splice(to, 0, moved);
        renderTable();
      }
    };

    row.innerHTML = `
      <td><input type="checkbox" onchange="toggleBulkActions()" /></td>
      <td>${task.number}</td>
      <td class="drag-handle">â˜°</td>
      <td contenteditable="true" oninput="tasks[${i}].name = this.textContent">${task.name}</td>
      <td>
        <select onchange="tasks[${i}].status = this.value">
          ${['Not Started', 'In Progress', 'Completed', 'Waiting on Someone'].map(
            s => `<option value="${s}" ${task.status === s ? 'selected' : ''}>${s}</option>`
          ).join('')}
        </select>
      </td>
      <td>
        <select onchange="updateGroup(${i}, this.value)">
          ${['group-independent', 'group-parallel', 'group-sequential'].map(
            g => `<option value="${g}" ${task.group === g ? 'selected' : ''}>${g.replace('group-', '')}</option>`
          ).join('')}
        </select>
      </td>
    `;

    tbody.appendChild(row);
  });
  toggleBulkActions();
}

function updateGroup(index, newGroup) {
  tasks[index].group = newGroup;
  tasks[index].groupKey = crypto.randomUUID();
  renderTable();
}

function addTask() {
  tasks.push({
    name: "New Task",
    status: "Not Started",
    group: "group-independent",
    groupKey: crypto.randomUUID()
  });
  renderTable();
}

function applyWorkflow() {
  const workflow = [
    "Gather client information",
    "Send client online medical",
    "Complete Application",
    "Send to client for eSign",
    "Submit to underwriting",
    "Delivery policy"
  ];
  const key = crypto.randomUUID();
  workflow.forEach(name => tasks.push({
    name,
    status: "Not Started",
    group: "group-sequential",
    groupKey: key
  }));
  renderTable();
}

function toggleBulkActions() {
  const anyChecked = [...document.querySelectorAll("tbody input[type='checkbox']")].some(cb => cb.checked);
  document.getElementById("bulkActions").style.display = anyChecked ? "block" : "none";
}

function deleteSelected() {
  const checkboxes = [...document.querySelectorAll("tbody input[type='checkbox']")];
  tasks = tasks.filter((_, i) => !checkboxes[i].checked);
  renderTable();
}

addTask(); // Initialize with one task
</script>

</body>
</html>
