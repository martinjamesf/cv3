<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Task Manager</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
    }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      gap: 1rem;
    }

    .action-buttons,
    .bulk-actions {
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }

    .btn {
      padding: 6px 12px;
      background-color: #eee;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
      height: 44px;
    }

    tr.dragging {
      opacity: 0.5;
    }

    .drag-handle {
      cursor: move;
    }

    input[type="text"],
    select {
      width: 100%;
      padding: 4px 6px;
      font-size: 0.9rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .hidden {
      display: none;
    }

    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      background: white;
      padding: 1rem;
      border: 1px solid #ccc;
      transform: translate(-50%, -50%);
      z-index: 999;
      min-width: 300px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      z-index: 998;
    }
  </style>
</head>

<body>

  <div class="top-bar">
    <div class="action-buttons">
      <button class="btn" onclick="addTask()">Add Task</button>
      <button class="btn" onclick="applyWorkflow()">Apply Workflows</button>
      <button class="btn" onclick="toggleEditMode()">
        <span id="editToggleText">Edit</span>
      </button>
    </div>
    <div class="bulk-actions" id="bulkActions">
      <select onchange="applyBulkGroup(this.value)">
        <option value="">Group by</option>
        <option value="Independent">Independent</option>
        <option value="Sequential">Sequential</option>
        <option value="Parallel">Parallel</option>
      </select>

      <select onchange="applyBulkStatus(this.value)">
        <option value="">Status</option>
        <option value="Not Started">Not Started</option>
        <option value="In Progress">In Progress</option>
        <option value="Completed">Completed</option>
        <option value="Waiting on Someone">Waiting on Someone</option>
      </select>

      <button class="btn" onclick="deleteSelected()">Delete</button>
    </div>
  </div>

  <table id="taskTable">
    <thead>
      <tr>
        <th></th>
        <th>#</th>
        <th>Task Name</th>
        <th>Status</th>
        <th>Group</th>
        <th>Task Creation Sequence</th>
      </tr>
    </thead>
    <tbody id="taskBody"></tbody>
  </table>

  <!-- Modal -->
  <div class="overlay hidden" id="modalOverlay" onclick="closeModal()"></div>
  <div class="modal hidden" id="taskModal">
    <div class="modal-header">
      <strong>Edit Task</strong>
      <button onclick="closeModal()">✕</button>
    </div>
    <div>
      <label>Task Name:</label>
      <input type="text" id="modalTaskName" />
    </div>
  </div>

  <script>
    let tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
    let editMode = false;
    let currentEditIndex = null;

    const taskBody = document.getElementById('taskBody');

    function saveToLocalStorage() {
      localStorage.setItem('tasks', JSON.stringify(tasks));
    }

    function addTask() {
      tasks.push({
        name: 'New Task',
        status: 'Not Started',
        group: 'Independent',
        creationSequence: ''
      });
      render();
    }

    function applyWorkflow() {
      const workflowSteps = [
        "Gather client information",
        "Send client online medical",
        "Complete Application",
        "Send to client for eSign",
        "Submit to underwriting",
        "Delivery policy"
      ];
      workflowSteps.forEach(name => {
        tasks.push({ name, status: 'Not Started', group: 'Independent', creationSequence: '' });
      });
      render();
    }

    function render() {
      taskBody.innerHTML = '';
      let numbering = [];
      let count = 1;

      for (let i = 0; i < tasks.length; i++) {
        const prev = tasks[i - 1];
        const curr = tasks[i];
        const next = tasks[i + 1];
        let num = '';

        if (curr.group === 'Sequential') {
          if (!prev || prev.group !== 'Sequential') {
            num = count + '.1';
          } else {
            let last = numbering[numbering.length - 1];
            let base = parseInt(last.split('.')[0]);
            let sub = parseInt(last.split('.')[1] || 0) + 1;
            num = `${base}.${sub}`;
          }
        } else if (curr.group === 'Parallel') {
          if (!prev || prev.group !== 'Parallel') {
            num = count;
          } else {
            num = numbering[numbering.length - 1];
          }
        } else {
          num = count;
        }

        numbering.push(num);
        if (!next || next.group !== curr.group) count++;

        const row = document.createElement('tr');
        row.setAttribute('draggable', 'true');
        row.className = 'task-row';

        row.innerHTML = `
          <td>
            <span class="drag-handle">☰</span>
            <input type="checkbox" onchange="toggleCheckbox(${i})">
          </td>
          <td>${num}</td>
          <td>
            ${editMode
            ? `<input type="text" value="${curr.name}" onchange="updateTaskName(${i}, this.value)">`
            : `<a href="#" onclick="openModal(${i})">${curr.name}</a>`}
          </td>
          <td>
            ${editMode
            ? `<select onchange="updateStatus(${i}, this.value)">
                  ${["Not Started", "In Progress", "Completed", "Waiting on Someone"].map(
              s => `<option ${s === curr.status ? "selected" : ""}>${s}</option>`
            ).join('')}
                </select>`
            : curr.status}
          </td>
          <td>
            ${editMode
            ? `<select onchange="updateGroup(${i}, this.value)">
                  ${["Independent", "Sequential", "Parallel"].map(
              g => `<option ${g === curr.group ? "selected" : ""}>${g}</option>`
            ).join('')}
                </select>`
            : curr.group}
          </td>
          <td><input type="text" value="${curr.creationSequence || ''}" onchange="updateTaskSequence(${i}, this.value)"></td>
        `;

        taskBody.appendChild(row);

        // Drag logic
        row.addEventListener('dragstart', e => {
          e.dataTransfer.setData('text/plain', i);
          row.classList.add('dragging');
        });
        row.addEventListener('dragend', () => row.classList.remove('dragging'));
        row.addEventListener('dragover', e => e.preventDefault());
        row.addEventListener('drop', e => {
          const from = +e.dataTransfer.getData('text/plain');
          const to = i;
          const moved = tasks.splice(from, 1)[0];
          tasks.splice(to, 0, moved);
          render();
          saveToLocalStorage();
        });
      }

      saveToLocalStorage();
    }

    function updateTaskName(i, value) {
      tasks[i].name = value;
      saveToLocalStorage();
    }

    function updateStatus(i, value) {
      tasks[i].status = value;
      saveToLocalStorage();
    }

    function updateGroup(i, value) {
      tasks[i].group = value;
      saveToLocalStorage();
    }

    function updateTaskSequence(i, value) {
      tasks[i].creationSequence = value;
      saveToLocalStorage();
    }

    function toggleCheckbox(index) {
      tasks[index].checked = !tasks[index].checked;
      render();
    }

    function deleteSelected() {
      tasks = tasks.filter(task => !task.checked);
      render();
    }

    function applyBulkGroup(group) {
      tasks.forEach(task => {
        if (task.checked) task.group = group;
      });
      render();
    }

    function applyBulkStatus(status) {
      tasks.forEach(task => {
        if (task.checked) task.status = status;
      });
      render();
    }

    function toggleEditMode() {
      editMode = !editMode;
      document.getElementById('editToggleText').innerText = editMode ? 'Save' : 'Edit';
      render();
    }

    function openModal(i) {
      currentEditIndex = i;
      document.getElementById('modalTaskName').value = tasks[i].name;
      document.getElementById('taskModal').classList.remove('hidden');
      document.getElementById('modalOverlay').classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('taskModal').classList.add('hidden');
      document.getElementById('modalOverlay').classList.add('hidden');
      if (currentEditIndex !== null) {
        tasks[currentEditIndex].name = document.getElementById('modalTaskName').value;
        render();
        saveToLocalStorage();
      }
      currentEditIndex = null;
    }

    render();
  </script>
</body>

</html>